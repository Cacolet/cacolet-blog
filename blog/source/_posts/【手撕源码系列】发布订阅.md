---
title: 【手撕源码系列】发布订阅
date: 2021-11-07 18:01:18
tags:
    - JavaScript
categories:
    - 手撕源码
keywords: "面试,js基础"
description: 
cover: https://img.cdn.sugarat.top/mdImg/MTY0NjcwNDYzODcwMA==646704638700




---

# 发布订阅(事件总线)

什么是发布订阅模式？

举一个简单的例子，我要卖四本书，但是目前我还不知道具体什么时间卖，或者不卖，然后我又不想直接与买家打交道，我就把我这四本书的信息放到一个交易平台让他们预定，然后当我真的想卖某一本书的时候，预定这一本书的人就会收到信息。

在这其中我就是发布者，买书的人就是订阅者，我们不直接交互，而是通过中间人来进行信息匹配

实现：

```js
class EventPubSub {
    constructor() {
        this.event = {}
    }

    // 订阅
    on(type,callback){
        if(!this.event[type]){
            this.event[type] = [callback]
        }else{
            this.event[type].push(callback)
        }
    }

    // 解除订阅
    off(type,callback){
        if(!this.event[type]){
            return ;
        }
        this.event[type] = this.event[type].filter(item =>{
            return item !== callback
        })
    }

    // 发布
    emit(type,...args){
        if(!this.event[type]){
            return ;
        }
        this.event[type].forEach(callback =>{
            callback.call(this,...args)
        })
    }
    // 执行一次
    once(type,callback){
        function f() {
            callback();
            this.off(type,f)
        }
        this.on(type,f)
    }
}

```

让我们来测试一下

```js
let eventBus = new EventPubSub()
let fn1 = function (name,age) {
    console.log(`${name}${age}`)
}

let fn2 = function (name,age) {
    console.log(`hello, ${name} ${age}`)
}

eventBus.on('aaa',fn1)
eventBus.on('bbb',fn2)
// eventBus.off('aaa',fn1)
eventBus.emit('bbb','布兰',12)  // hello, 布兰 12
```

发布订阅的实现ok了